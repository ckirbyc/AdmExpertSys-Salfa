@using CL.AdmExpertSys.WEB.Presentation.ViewModel
@model IEnumerable<EstadoCuentaUsuarioVm>
@{
    ViewBag.Title = "Proceso Asignar Licencias";
    Layout = "~/Views/_Main.cshtml";

    bool esLicencia = ViewBag.EstadoLicencia;
    var msgLicencia = string.Empty;

    if (esLicencia)
    {
        msgLicencia = "Proceso en ejecución, actualice la página para comprobar que el proceso ha terminado.";
    }
    else if (esLicencia == false && Model.Count() == 0)
    {
        msgLicencia = "No existen datos para asignar licencias.";
    }
}

<div class="row">
    <h1 class="page-header colorOrange col-md-9">Proceso Asignar Licencias Cuentas Usuarios</h1>
    <div class="form-inline col-md-3">
        <div id="btnLicencia" class="btn btn-primary pull-right btn-sm">
            <span class="glyphicon glyphicon-save"></span>
            <input type="button" value="Asignar Licencia" class="btnInput" id="AsignarLicencia" data-loading-text="Asignando..." data-toggle="tooltip" data-placement="bottom" title="@msgLicencia" />
        </div>
    </div>
</div>
<div class="row">
    <h2 class="sub-header">Vista de todas las cuentas que no poseen una asignación de Licencia.</h2>
</div>
<div class="row">
    <table class="table table-hover tablaMantenedores">
        <thead>
            <tr>
                <th>Cuenta AD</th>
                <th>Nombres</th>
                <th>Apellidos</th>
                <th>Correo</th>
                <th>Upn</th>
                <th>Licencia</th>
                <th>Código</th>
            </tr>
        </thead>
        @foreach (var item in Model.OrderByDescending(x => x.CuentaAd))
        {
            var item1 = item;
            <tr>
                <td class="textCenter">@Html.DisplayFor(m => item1.CuentaAd)</td>
                <td class="textCenter">@Html.DisplayFor(m => item1.Nombres)</td>
                <td class="textCenter">@Html.DisplayFor(m => item1.Apellidos)</td>
                <td class="textCenter">@Html.DisplayFor(m => item1.Correo)</td>
                <td class="textCenter">@Html.DisplayFor(m => item1.Dominio)</td>
                <td class="textCenter">@Html.DisplayFor(m => item1.LICENCIAS_O365.Nombre)</td>
                <td class="textCenter">@Html.DisplayFor(m => item1.LICENCIAS_O365.Codigo)</td>
            </tr>
        }
    </table>
</div>
<script src="~/Scripts/Tabla/ConfiguracionTabla.js"></script>
<script src="~/Scripts/Menu/ActivaMenu.js"></script>
<script>
    $('#AsigLicencia').addClass('active');
</script>
<script>
    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();

        $("#btnLicencia").off('click').click(function () {
            var $btn = $("#AsignarLicencia");
            $btn.button('loading');

            if ('@Model.Count()' == 0 || '@esLicencia' == 'True') {
                BootstrapDialog.alert({
                    title: '¡Validación Inicio Proceso!',
                    message: '<strong>No se puede iniciar el proceso de asignación de licencia, se puede deber a:</br>1.- Proceso en ejecución</br>2.- No existen datos asignar</strong>',
                    type: BootstrapDialog.TYPE_WARNING
                });
                $btn.button('reset');
                return;
            }

            BootstrapDialog.show({
                title: 'Confirmación Asignar Licencias.',
                message: '<strong>¿Está seguro de asignar licencias de todas las cuentas que aparecen en la tabla?</strong>',
                type: BootstrapDialog.TYPE_INFO,
                buttons:
                    [
                        {
                            label: 'Si',
                            cssClass: 'btn-success',
                            action: function (dialog) {
                                dialog.close();
                                $("#loading-modal").show();
                                $("#btnLicencia").attr("disabled", true);
                                setTimeout(function () {
                                    asignarLicencias();
                                }, 500);
                            }
                        },
                        {
                            label: 'No',
                            cssClass: 'btn-danger',
                            action: function (dialog) {
                                dialog.close();
                                $btn.button('reset');
                            }
                        }
                    ]
            });                                              
        });

        function asignarLicencias()
        {
            $.ajax({
                url: '@Url.Action("AsignarLicencia", "LicCuenta")',
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                async: false,
                dataType: 'json',
                processData: false,                
                success: function (data) {
                    if (data.Session == false) {
                        BootstrapDialog.alert({
			                    title: '¡Validación Sesión!',
			                    message: '<strong>Su sesión ha expirado. Seleccione <a href="@Url.Action("IndexLogin", "Error", new { mensajeError = "Su sesión ha expirado." })">aquí</a> para iniciar sesión nuevamente</strong>',
			                    type: BootstrapDialog.TYPE_WARNING
		                    });
                        return;
                    }

                    if (data.Validar) {
                        BootstrapDialog.alert({
                            title: '¡Ejecución proceso iniciado!',
                            message: '<strong>Proceso de asignación licencia iniciado correctamente.</br>Para revisar el estado hacer click <a href="@Url.Action("Index", "UsuarioCreado")">aquí</a></strong>',
                            type: BootstrapDialog.TYPE_SUCCESS
                        });
                    } else {
                        BootstrapDialog.alert({
                            title: '¡Error al iniciar el proceso!',
                            message: '<strong>Error al ejecutar el proceso de asignación licencia. ' + data.Error + '</strong>',
                            type: BootstrapDialog.TYPE_DANGER
                        });
                    }
                },
                complete: function () {
                    $("#loading-modal").hide();
                },
                error: function () {
                    $("#loading-modal").hide();
                    BootstrapDialog.alert({
                        title: '¡Error al iniciar el proceso!',
                        message: '<strong>Error al ejecutar el proceso de asignación licencia.</strong>',
                        type: BootstrapDialog.TYPE_DANGER
                    });
                }
            });
        }
    });
</script>